<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Recettes Manquantes</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagnostic Recettes Manquantes</h1>
        <p>Ce script va diagnostiquer pourquoi votre recette "Salaire octobre" n'appara√Æt pas.</p>
        
        <div class="section">
            <h3>Configuration Supabase</h3>
            <button class="btn" onclick="testConnection()">Tester la Connexion</button>
            <div id="connection-result"></div>
        </div>

        <div class="section">
            <h3>Structure de la Table Recettes</h3>
            <button class="btn" onclick="checkTableStructure()">V√©rifier la Structure</button>
            <div id="structure-result"></div>
        </div>

        <div class="section">
            <h3>Recettes Existantes</h3>
            <button class="btn" onclick="getAllRecettes()">R√©cup√©rer Toutes les Recettes</button>
            <div id="recettes-result"></div>
        </div>

        <div class="section">
            <h3>Recherche Sp√©cifique "Salaire octobre"</h3>
            <button class="btn" onclick="searchSalaireOctobre()">Rechercher "Salaire octobre"</button>
            <div id="search-result"></div>
        </div>

        <div class="section">
            <h3>Test de Cr√©ation</h3>
            <button class="btn btn-success" onclick="createTestRecette()">Cr√©er Recette de Test</button>
            <div id="create-result"></div>
        </div>

        <div class="section">
            <h3>Actions de R√©paration</h3>
            <button class="btn btn-warning" onclick="fixTableStructure()">Corriger la Structure</button>
            <button class="btn btn-danger" onclick="clearTestData()">Nettoyer les Donn√©es de Test</button>
            <div id="fix-result"></div>
        </div>
    </div>

    <script>
        // Configuration Supabase
        const supabaseUrl = 'https://judrexutbqlfutjbtenf.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp1ZHJleHV0YnFsZnV0amJ0ZW5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwODAwODgsImV4cCI6MjA3NDY1NjA4OH0.C7B9zKsQqLUvLuaPi2RbrhdLPvoJdnwpsYaRJhkRMmU'
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)

        async function testConnection() {
            const resultDiv = document.getElementById('connection-result')
            resultDiv.innerHTML = '<p>üîÑ Test de connexion en cours...</p>'
            
            try {
                const { data: { user }, error } = await supabase.auth.getUser()
                if (error) {
                    resultDiv.innerHTML = `<div class="error"><h4>‚ùå Erreur d'authentification</h4><pre>${JSON.stringify(error, null, 2)}</pre></div>`
                } else if (user) {
                    resultDiv.innerHTML = `<div class="success"><h4>‚úÖ Connexion r√©ussie</h4><p>Utilisateur: ${user.email} (ID: ${user.id})</p></div>`
                } else {
                    resultDiv.innerHTML = `<div class="warning"><h4>‚ö†Ô∏è Aucun utilisateur connect√©</h4><p>Veuillez vous connecter d'abord</p></div>`
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="error"><h4>‚ùå Erreur de connexion</h4><pre>${err.message}</pre></div>`
            }
        }

        async function checkTableStructure() {
            const resultDiv = document.getElementById('structure-result')
            resultDiv.innerHTML = '<p>üîÑ V√©rification de la structure...</p>'
            
            try {
                // Test avec diff√©rentes colonnes possibles
                const tests = [
                    { name: 'libelle + montant', query: () => supabase.from('recettes').select('libelle, montant').limit(1) },
                    { name: 'description + amount', query: () => supabase.from('recettes').select('description, amount').limit(1) },
                    { name: 'toutes les colonnes', query: () => supabase.from('recettes').select('*').limit(1) }
                ]
                
                let results = '<h4>Structure de la table recettes:</h4>'
                
                for (const test of tests) {
                    try {
                        const { data, error } = await test.query()
                        if (error) {
                            results += `<div class="error"><strong>${test.name}:</strong> ‚ùå ${error.message}</div>`
                        } else {
                            results += `<div class="success"><strong>${test.name}:</strong> ‚úÖ Fonctionne</div>`
                            if (data && data.length > 0) {
                                results += `<pre>${JSON.stringify(data[0], null, 2)}</pre>`
                            }
                        }
                    } catch (err) {
                        results += `<div class="error"><strong>${test.name}:</strong> ‚ùå ${err.message}</div>`
                    }
                }
                
                resultDiv.innerHTML = results
            } catch (err) {
                resultDiv.innerHTML = `<div class="error"><h4>‚ùå Erreur</h4><pre>${err.message}</pre></div>`
            }
        }

        async function getAllRecettes() {
            const resultDiv = document.getElementById('recettes-result')
            resultDiv.innerHTML = '<p>üîÑ R√©cup√©ration des recettes...</p>'
            
            try {
                // Essayer avec les deux structures possibles
                const { data: data1, error: error1 } = await supabase
                    .from('recettes')
                    .select('*')
                    .order('created_at', { ascending: false })
                
                if (error1) {
                    resultDiv.innerHTML = `<div class="error"><h4>‚ùå Erreur</h4><pre>${JSON.stringify(error1, null, 2)}</pre></div>`
                    return
                }
                
                if (!data1 || data1.length === 0) {
                    resultDiv.innerHTML = `<div class="warning"><h4>‚ö†Ô∏è Aucune recette trouv√©e</h4><p>La table est vide ou inaccessible</p></div>`
                    return
                }
                
                let table = '<h4>Recettes trouv√©es:</h4><table><tr><th>ID</th><th>Libell√©/Description</th><th>Montant/Amount</th><th>Date</th><th>Statut</th></tr>'
                
                data1.forEach(recette => {
                    const libelle = recette.libelle || recette.description || 'N/A'
                    const montant = recette.montant || recette.amount || 0
                    const date = recette.date_reception || recette.receipt_date || recette.created_at || 'N/A'
                    const statut = recette.statut || 'N/A'
                    
                    table += `<tr>
                        <td>${recette.id}</td>
                        <td>${libelle}</td>
                        <td>${montant}</td>
                        <td>${date}</td>
                        <td>${statut}</td>
                    </tr>`
                })
                
                table += '</table>'
                resultDiv.innerHTML = `<div class="success">${table}</div>`
                
            } catch (err) {
                resultDiv.innerHTML = `<div class="error"><h4>‚ùå Erreur</h4><pre>${err.message}</pre></div>`
            }
        }

        async function searchSalaireOctobre() {
            const resultDiv = document.getElementById('search-result')
            resultDiv.innerHTML = '<p>üîÑ Recherche de "Salaire octobre"...</p>'
            
            try {
                // Rechercher dans libelle
                const { data: data1, error: error1 } = await supabase
                    .from('recettes')
                    .select('*')
                    .ilike('libelle', '%salaire%octobre%')
                
                // Rechercher dans description
                const { data: data2, error: error2 } = await supabase
                    .from('recettes')
                    .select('*')
                    .ilike('description', '%salaire%octobre%')
                
                let results = '<h4>R√©sultats de recherche:</h4>'
                
                if (error1 && error2) {
                    results += `<div class="error">Erreurs: ${error1.message} | ${error2.message}</div>`
                } else {
                    const allResults = [...(data1 || []), ...(data2 || [])]
                    
                    if (allResults.length === 0) {
                        results += `<div class="warning">Aucune recette "Salaire octobre" trouv√©e</div>`
                    } else {
                        results += `<div class="success">Trouv√© ${allResults.length} recette(s):</div>`
                        allResults.forEach(recette => {
                            results += `<pre>${JSON.stringify(recette, null, 2)}</pre>`
                        })
                    }
                }
                
                resultDiv.innerHTML = results
                
            } catch (err) {
                resultDiv.innerHTML = `<div class="error"><h4>‚ùå Erreur</h4><pre>${err.message}</pre></div>`
            }
        }

        async function createTestRecette() {
            const resultDiv = document.getElementById('create-result')
            resultDiv.innerHTML = '<p>üîÑ Cr√©ation d\'une recette de test...</p>'
            
            try {
                const { data: { user }, error: authError } = await supabase.auth.getUser()
                if (authError || !user) {
                    resultDiv.innerHTML = `<div class="error"><h4>‚ùå Erreur d'authentification</h4><pre>${JSON.stringify(authError, null, 2)}</pre></div>`
                    return
                }
                
                // Essayer avec la structure libelle/montant
                const { data: data1, error: error1 } = await supabase
                    .from('recettes')
                    .insert({
                        user_id: user.id,
                        libelle: 'Test Salaire Octobre - ' + new Date().toISOString(),
                        montant: 500000,
                        solde_disponible: 500000,
                        date_reception: new Date().toISOString().split('T')[0],
                        statut: 're√ßue'
                    })
                    .select()
                    .single()
                
                if (error1) {
                    // Essayer avec la structure description/amount
                    const { data: data2, error: error2 } = await supabase
                        .from('recettes')
                        .insert({
                            user_id: user.id,
                            description: 'Test Salaire Octobre - ' + new Date().toISOString(),
                            amount: 500000,
                            solde_disponible: 500000,
                            receipt_date: new Date().toISOString().split('T')[0]
                        })
                        .select()
                        .single()
                    
                    if (error2) {
                        resultDiv.innerHTML = `<div class="error"><h4>‚ùå Erreur de cr√©ation</h4><pre>Structure libelle/montant: ${error1.message}\n\nStructure description/amount: ${error2.message}</pre></div>`
                    } else {
                        resultDiv.innerHTML = `<div class="success"><h4>‚úÖ Recette cr√©√©e avec description/amount</h4><pre>${JSON.stringify(data2, null, 2)}</pre></div>`
                    }
                } else {
                    resultDiv.innerHTML = `<div class="success"><h4>‚úÖ Recette cr√©√©e avec libelle/montant</h4><pre>${JSON.stringify(data1, null, 2)}</pre></div>`
                }
                
            } catch (err) {
                resultDiv.innerHTML = `<div class="error"><h4>‚ùå Erreur</h4><pre>${err.message}</pre></div>`
            }
        }

        async function fixTableStructure() {
            const resultDiv = document.getElementById('fix-result')
            resultDiv.innerHTML = '<p>üîÑ Correction de la structure...</p>'
            
            try {
                // Cette fonction n√©cessiterait des privil√®ges admin
                resultDiv.innerHTML = `<div class="warning"><h4>‚ö†Ô∏è Correction manuelle requise</h4><p>La correction de la structure n√©cessite des privil√®ges administrateur. Veuillez ex√©cuter les migrations SQL appropri√©es.</p></div>`
            } catch (err) {
                resultDiv.innerHTML = `<div class="error"><h4>‚ùå Erreur</h4><pre>${err.message}</pre></div>`
            }
        }

        async function clearTestData() {
            const resultDiv = document.getElementById('fix-result')
            resultDiv.innerHTML = '<p>üîÑ Nettoyage des donn√©es de test...</p>'
            
            try {
                const { data: { user }, error: authError } = await supabase.auth.getUser()
                if (authError || !user) {
                    resultDiv.innerHTML = `<div class="error"><h4>‚ùå Erreur d'authentification</h4></div>`
                    return
                }
                
                const { error } = await supabase
                    .from('recettes')
                    .delete()
                    .ilike('libelle', '%Test Salaire Octobre%')
                
                if (error) {
                    resultDiv.innerHTML = `<div class="error"><h4>‚ùå Erreur de suppression</h4><pre>${error.message}</pre></div>`
                } else {
                    resultDiv.innerHTML = `<div class="success"><h4>‚úÖ Donn√©es de test supprim√©es</h4></div>`
                }
                
            } catch (err) {
                resultDiv.innerHTML = `<div class="error"><h4>‚ùå Erreur</h4><pre>${err.message}</pre></div>`
            }
        }

        // Auto-test au chargement
        window.onload = function() {
            testConnection()
        }
    </script>
</body>
</html>




