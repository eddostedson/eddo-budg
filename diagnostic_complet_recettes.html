<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Complet - Recettes Manquantes</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; }
        .btn-info { background: #17a2b8; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        th { background: #f8f9fa; font-weight: bold; }
        .log { background: #000; color: #0f0; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 11px; max-height: 300px; overflow-y: auto; }
        .step { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .step.success { border-left-color: #28a745; background: #d4edda; }
        .step.error { border-left-color: #dc3545; background: #f8d7da; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagnostic Complet - Recettes Manquantes</h1>
        <p>Ce script va effectuer un diagnostic approfondi pour retrouver vos recettes perdues.</p>
        
        <div class="section">
            <h3>üöÄ Diagnostic Automatique</h3>
            <button class="btn btn-success" onclick="runFullDiagnostic()">Lancer le Diagnostic Complet</button>
            <button class="btn btn-info" onclick="clearLogs()">Effacer les Logs</button>
            <div id="diagnostic-log" class="log" style="display: none;"></div>
        </div>

        <div class="section">
            <h3>üìä R√©sultats du Diagnostic</h3>
            <div id="diagnostic-results"></div>
        </div>

        <div class="section">
            <h3>üîß Actions de R√©paration</h3>
            <button class="btn btn-warning" onclick="createMissingTable()">Cr√©er Table Manquante</button>
            <button class="btn btn-info" onclick="syncData()">Synchroniser les Donn√©es</button>
            <button class="btn btn-success" onclick="createTestRecette()">Cr√©er Recette de Test</button>
            <div id="repair-results"></div>
        </div>

        <div class="section">
            <h3>üìã Toutes les Tables Disponibles</h3>
            <button class="btn" onclick="listAllTables()">Lister Toutes les Tables</button>
            <div id="tables-result"></div>
        </div>

        <div class="section">
            <h3>üîç Recherche Avanc√©e</h3>
            <input type="text" id="search-term" placeholder="Rechercher une recette..." style="padding: 8px; margin: 5px; width: 300px;">
            <button class="btn" onclick="advancedSearch()">Rechercher</button>
            <div id="search-results"></div>
        </div>
    </div>

    <script>
        // Configuration Supabase
        const supabaseUrl = 'https://judrexutbqlfutjbtenf.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp1ZHJleHV0YnFsZnV0amJ0ZW5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwODAwODgsImV4cCI6MjA3NDY1NjA4OH0.C7B9zKsQqLUvLuaPi2RbrhdLPvoJdnwpsYaRJhkRMmU'
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)
        
        let diagnosticLog = []

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString()
            const logEntry = `[${timestamp}] ${message}`
            diagnosticLog.push(logEntry)
            
            const logDiv = document.getElementById('diagnostic-log')
            logDiv.style.display = 'block'
            logDiv.innerHTML = diagnosticLog.join('\n')
            logDiv.scrollTop = logDiv.scrollHeight
            
            console.log(logEntry)
        }

        function clearLogs() {
            diagnosticLog = []
            document.getElementById('diagnostic-log').innerHTML = ''
            document.getElementById('diagnostic-results').innerHTML = ''
        }

        async function runFullDiagnostic() {
            clearLogs()
            log('üöÄ D√©but du diagnostic complet...')
            
            const resultsDiv = document.getElementById('diagnostic-results')
            resultsDiv.innerHTML = '<div class="step">üîÑ Diagnostic en cours...</div>'
            
            let steps = []
            
            try {
                // √âtape 1: V√©rifier l'authentification
                log('√âtape 1: V√©rification de l\'authentification...')
                const { data: { user }, error: authError } = await supabase.auth.getUser()
                if (authError || !user) {
                    steps.push({ status: 'error', message: '‚ùå Erreur d\'authentification: ' + (authError?.message || 'Utilisateur non connect√©') })
                    log('‚ùå √âchec de l\'authentification: ' + (authError?.message || 'Utilisateur non connect√©'))
                } else {
                    steps.push({ status: 'success', message: '‚úÖ Authentification OK - Utilisateur: ' + user.email })
                    log('‚úÖ Authentification r√©ussie: ' + user.email + ' (ID: ' + user.id + ')')
                }

                // √âtape 2: V√©rifier l'existence de la table recettes
                log('√âtape 2: V√©rification de l\'existence de la table recettes...')
                const { data: recettesData, error: recettesError } = await supabase
                    .from('recettes')
                    .select('*')
                    .limit(1)
                
                if (recettesError) {
                    steps.push({ status: 'error', message: '‚ùå Table recettes inaccessible: ' + recettesError.message })
                    log('‚ùå Erreur table recettes: ' + recettesError.message)
                } else {
                    steps.push({ status: 'success', message: '‚úÖ Table recettes accessible' })
                    log('‚úÖ Table recettes accessible')
                }

                // √âtape 3: Compter les recettes
                log('√âtape 3: Comptage des recettes...')
                const { count, error: countError } = await supabase
                    .from('recettes')
                    .select('*', { count: 'exact', head: true })
                
                if (countError) {
                    steps.push({ status: 'error', message: '‚ùå Erreur comptage: ' + countError.message })
                    log('‚ùå Erreur comptage: ' + countError.message)
                } else {
                    steps.push({ status: 'info', message: 'üìä Nombre total de recettes: ' + count })
                    log('üìä Nombre total de recettes: ' + count)
                }

                // √âtape 4: R√©cup√©rer toutes les recettes
                log('√âtape 4: R√©cup√©ration de toutes les recettes...')
                const { data: allRecettes, error: allError } = await supabase
                    .from('recettes')
                    .select('*')
                    .order('created_at', { ascending: false })
                
                if (allError) {
                    steps.push({ status: 'error', message: '‚ùå Erreur r√©cup√©ration: ' + allError.message })
                    log('‚ùå Erreur r√©cup√©ration: ' + allError.message)
                } else {
                    steps.push({ status: 'success', message: '‚úÖ R√©cup√©ration r√©ussie: ' + (allRecettes?.length || 0) + ' recettes' })
                    log('‚úÖ R√©cup√©ration r√©ussie: ' + (allRecettes?.length || 0) + ' recettes')
                    
                    if (allRecettes && allRecettes.length > 0) {
                        log('üìã D√©tail des recettes:')
                        allRecettes.forEach((recette, index) => {
                            const libelle = recette.libelle || recette.description || 'N/A'
                            const montant = recette.montant || recette.amount || 0
                            log(`  ${index + 1}. ${libelle} - ${montant} F CFA`)
                        })
                    }
                }

                // √âtape 5: Rechercher "Salaire octobre"
                log('√âtape 5: Recherche sp√©cifique "Salaire octobre"...')
                const searchTerms = ['salaire octobre', 'octobre', 'salaire']
                let foundRecettes = []
                
                for (const term of searchTerms) {
                    const { data: searchData, error: searchError } = await supabase
                        .from('recettes')
                        .select('*')
                        .or(`libelle.ilike.%${term}%,description.ilike.%${term}%`)
                    
                    if (!searchError && searchData) {
                        foundRecettes = [...foundRecettes, ...searchData]
                    }
                }
                
                if (foundRecettes.length > 0) {
                    steps.push({ status: 'success', message: '‚úÖ Recettes "Salaire octobre" trouv√©es: ' + foundRecettes.length })
                    log('‚úÖ Recettes "Salaire octobre" trouv√©es: ' + foundRecettes.length)
                    foundRecettes.forEach(recette => {
                        log('  - ' + (recette.libelle || recette.description) + ' - ' + (recette.montant || recette.amount) + ' F CFA')
                    })
                } else {
                    steps.push({ status: 'warning', message: '‚ö†Ô∏è Aucune recette "Salaire octobre" trouv√©e' })
                    log('‚ö†Ô∏è Aucune recette "Salaire octobre" trouv√©e')
                }

                // √âtape 6: V√©rifier les permissions RLS
                log('√âtape 6: V√©rification des permissions RLS...')
                const { data: rlsData, error: rlsError } = await supabase
                    .rpc('get_table_info', { table_name: 'recettes' })
                    .catch(() => ({ data: null, error: { message: 'Fonction RPC non disponible' } }))
                
                if (rlsError) {
                    steps.push({ status: 'warning', message: '‚ö†Ô∏è Impossible de v√©rifier RLS: ' + rlsError.message })
                    log('‚ö†Ô∏è Impossible de v√©rifier RLS: ' + rlsError.message)
                } else {
                    steps.push({ status: 'info', message: '‚ÑπÔ∏è V√©rification RLS effectu√©e' })
                    log('‚ÑπÔ∏è V√©rification RLS effectu√©e')
                }

                // Afficher les r√©sultats
                let resultsHtml = '<h4>R√©sultats du Diagnostic:</h4>'
                steps.forEach(step => {
                    const stepClass = step.status === 'success' ? 'success' : 
                                    step.status === 'error' ? 'error' : 
                                    step.status === 'warning' ? 'warning' : 'info'
                    resultsHtml += `<div class="step ${stepClass}">${step.message}</div>`
                })
                
                resultsDiv.innerHTML = resultsHtml
                log('‚úÖ Diagnostic termin√©!')
                
            } catch (error) {
                log('‚ùå Erreur critique: ' + error.message)
                steps.push({ status: 'error', message: '‚ùå Erreur critique: ' + error.message })
                resultsDiv.innerHTML = '<div class="step error">‚ùå Erreur critique: ' + error.message + '</div>'
            }
        }

        async function listAllTables() {
            const resultDiv = document.getElementById('tables-result')
            resultDiv.innerHTML = '<p>üîÑ R√©cup√©ration des tables...</p>'
            
            try {
                // Essayer de r√©cup√©rer des informations sur les tables
                const tables = ['recettes', 'depenses', 'budgets', 'users', 'profiles']
                let results = '<h4>Tables disponibles:</h4><table><tr><th>Table</th><th>Statut</th><th>Colonnes</th></tr>'
                
                for (const table of tables) {
                    try {
                        const { data, error } = await supabase
                            .from(table)
                            .select('*')
                            .limit(1)
                        
                        if (error) {
                            results += `<tr><td>${table}</td><td>‚ùå ${error.message}</td><td>-</td></tr>`
                        } else {
                            const columns = data && data.length > 0 ? Object.keys(data[0]).join(', ') : 'Aucune donn√©e'
                            results += `<tr><td>${table}</td><td>‚úÖ Accessible</td><td>${columns}</td></tr>`
                        }
                    } catch (err) {
                        results += `<tr><td>${table}</td><td>‚ùå ${err.message}</td><td>-</td></tr>`
                    }
                }
                
                results += '</table>'
                resultDiv.innerHTML = results
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Erreur: ${error.message}</div>`
            }
        }

        async function advancedSearch() {
            const searchTerm = document.getElementById('search-term').value
            const resultDiv = document.getElementById('search-results')
            
            if (!searchTerm) {
                resultDiv.innerHTML = '<div class="warning">Veuillez entrer un terme de recherche</div>'
                return
            }
            
            resultDiv.innerHTML = '<p>üîÑ Recherche en cours...</p>'
            
            try {
                const { data, error } = await supabase
                    .from('recettes')
                    .select('*')
                    .or(`libelle.ilike.%${searchTerm}%,description.ilike.%${searchTerm}%`)
                
                if (error) {
                    resultDiv.innerHTML = `<div class="error">Erreur: ${error.message}</div>`
                    return
                }
                
                if (!data || data.length === 0) {
                    resultDiv.innerHTML = `<div class="warning">Aucune recette trouv√©e pour "${searchTerm}"</div>`
                    return
                }
                
                let table = `<h4>R√©sultats pour "${searchTerm}" (${data.length} trouv√©e(s)):</h4><table><tr><th>ID</th><th>Libell√©</th><th>Montant</th><th>Date</th><th>Statut</th></tr>`
                
                data.forEach(recette => {
                    const libelle = recette.libelle || recette.description || 'N/A'
                    const montant = recette.montant || recette.amount || 0
                    const date = recette.date_reception || recette.receipt_date || recette.created_at || 'N/A'
                    const statut = recette.statut || 'N/A'
                    
                    table += `<tr>
                        <td>${recette.id}</td>
                        <td>${libelle}</td>
                        <td>${montant} F CFA</td>
                        <td>${date}</td>
                        <td>${statut}</td>
                    </tr>`
                })
                
                table += '</table>'
                resultDiv.innerHTML = table
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Erreur: ${error.message}</div>`
            }
        }

        async function createTestRecette() {
            const resultDiv = document.getElementById('repair-results')
            resultDiv.innerHTML = '<p>üîÑ Cr√©ation d\'une recette de test...</p>'
            
            try {
                const { data: { user }, error: authError } = await supabase.auth.getUser()
                if (authError || !user) {
                    resultDiv.innerHTML = `<div class="error">Erreur d'authentification: ${authError?.message}</div>`
                    return
                }
                
                const testRecette = {
                    user_id: user.id,
                    libelle: 'Test Recette - ' + new Date().toLocaleString(),
                    montant: 100000,
                    solde_disponible: 100000,
                    date_reception: new Date().toISOString().split('T')[0],
                    statut: 're√ßue'
                }
                
                const { data, error } = await supabase
                    .from('recettes')
                    .insert(testRecette)
                    .select()
                    .single()
                
                if (error) {
                    resultDiv.innerHTML = `<div class="error">Erreur de cr√©ation: ${error.message}</div>`
                } else {
                    resultDiv.innerHTML = `<div class="success">‚úÖ Recette de test cr√©√©e avec succ√®s!<br><pre>${JSON.stringify(data, null, 2)}</pre></div>`
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Erreur: ${error.message}</div>`
            }
        }

        async function createMissingTable() {
            const resultDiv = document.getElementById('repair-results')
            resultDiv.innerHTML = '<div class="warning">‚ö†Ô∏è Cette fonction n√©cessite des privil√®ges administrateur. Veuillez ex√©cuter les migrations SQL appropri√©es.</div>'
        }

        async function syncData() {
            const resultDiv = document.getElementById('repair-results')
            resultDiv.innerHTML = '<p>üîÑ Synchronisation des donn√©es...</p>'
            
            try {
                // Forcer le rechargement des donn√©es
                const { data, error } = await supabase
                    .from('recettes')
                    .select('*')
                    .order('created_at', { ascending: false })
                
                if (error) {
                    resultDiv.innerHTML = `<div class="error">Erreur de synchronisation: ${error.message}</div>`
                } else {
                    resultDiv.innerHTML = `<div class="success">‚úÖ Synchronisation r√©ussie! ${data?.length || 0} recettes trouv√©es.</div>`
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Erreur: ${error.message}</div>`
            }
        }

        // Auto-diagnostic au chargement
        window.onload = function() {
            runFullDiagnostic()
        }
    </script>
</body>
</html>



