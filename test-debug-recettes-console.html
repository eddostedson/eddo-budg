<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Recettes - Console Interactive</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: scale(1.05);
        }
        .result {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        .error {
            color: #ff4444;
        }
        .success {
            color: #00ff00;
        }
        .warning {
            color: #ffaa00;
        }
        .info {
            color: #4444ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Recettes - Diagnostic Complet</h1>
        
        <div class="section">
            <h3>Configuration Supabase</h3>
            <input type="text" id="supabaseUrl" placeholder="URL Supabase" style="width: 100%; padding: 10px; margin: 5px 0;">
            <input type="text" id="supabaseKey" placeholder="Cl√© Anon Supabase" style="width: 100%; padding: 10px; margin: 5px 0;">
            <button onclick="initSupabase()">üîå Connecter Supabase</button>
        </div>

        <div class="section">
            <h3>Tests de Diagnostic</h3>
            <button onclick="testAuth()">1. üîê V√©rifier Authentification</button>
            <button onclick="testRecettesRaw()">2. üìä R√©cup√©rer Recettes Brutes</button>
            <button onclick="testMapping()">3. üîÑ Tester Mapping</button>
            <button onclick="testCalculTotal()">4. üí∞ Calculer Total</button>
            <button onclick="runAllTests()">‚ñ∂Ô∏è Tout Ex√©cuter</button>
        </div>

        <div class="section">
            <h3>R√©sultats</h3>
            <div id="results" class="result">En attente des tests...</div>
        </div>
    </div>

    <script>
        let supabase = null;
        let recettesData = null;

        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': '#4444ff',
                'success': '#00ff00',
                'error': '#ff4444',
                'warning': '#ffaa00'
            };
            const color = colors[type] || '#00ff00';
            resultsDiv.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function clear() {
            document.getElementById('results').innerHTML = '';
        }

        function initSupabase() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;

            if (!url || !key) {
                log('‚ùå Veuillez remplir l\'URL et la cl√© Supabase', 'error');
                return;
            }

            try {
                supabase = window.supabase.createClient(url, key);
                log('‚úÖ Supabase initialis√© avec succ√®s', 'success');
            } catch (error) {
                log(`‚ùå Erreur d'initialisation: ${error.message}`, 'error');
            }
        }

        async function testAuth() {
            clear();
            log('üîç Test 1: V√©rification de l\'authentification...', 'info');

            if (!supabase) {
                log('‚ùå Supabase non initialis√©', 'error');
                return;
            }

            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error) {
                    log(`‚ùå Erreur d'authentification: ${error.message}`, 'error');
                    return;
                }

                if (!user) {
                    log('‚ùå Aucun utilisateur connect√©', 'error');
                    log('üí° Connectez-vous d\'abord dans votre application', 'warning');
                    return;
                }

                log('‚úÖ Utilisateur connect√©:', 'success');
                log(`   - ID: ${user.id}`, 'success');
                log(`   - Email: ${user.email}`, 'success');
                log(`   - Cr√©√© le: ${new Date(user.created_at).toLocaleString()}`, 'success');
                
                return user;
            } catch (error) {
                log(`‚ùå Erreur inattendue: ${error.message}`, 'error');
            }
        }

        async function testRecettesRaw() {
            clear();
            log('üîç Test 2: R√©cup√©ration des recettes brutes...', 'info');

            if (!supabase) {
                log('‚ùå Supabase non initialis√©', 'error');
                return;
            }

            try {
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    log('‚ùå Non authentifi√©', 'error');
                    return;
                }

                log(`üîê Utilisateur: ${user.email}`, 'info');

                const { data, error } = await supabase
                    .from('recettes')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false });

                if (error) {
                    log(`‚ùå Erreur SQL: ${error.message}`, 'error');
                    log(`   Code: ${error.code}`, 'error');
                    log(`   D√©tails: ${error.details}`, 'error');
                    return;
                }

                log(`‚úÖ Recettes r√©cup√©r√©es: ${data?.length || 0}`, 'success');
                
                if (data && data.length > 0) {
                    recettesData = data;
                    log('\nüìã Structure de la premi√®re recette:', 'info');
                    log(JSON.stringify(data[0], null, 2), 'info');
                    
                    log('\nüîë Colonnes disponibles:', 'info');
                    Object.keys(data[0]).forEach(key => {
                        const value = data[0][key];
                        const type = typeof value;
                        log(`   - ${key}: ${type} = ${value}`, 'info');
                    });

                    log('\nüìä Statistiques:', 'info');
                    log(`   - Nombre de recettes: ${data.length}`, 'success');
                    
                    // V√©rifier les colonnes de montant
                    const hasAmount = 'amount' in data[0];
                    const hasMontant = 'montant' in data[0];
                    log(`   - Colonne 'amount': ${hasAmount ? '‚úÖ OUI' : '‚ùå NON'}`, hasAmount ? 'success' : 'error');
                    log(`   - Colonne 'montant': ${hasMontant ? '‚úÖ OUI' : '‚ùå NON'}`, hasMontant ? 'success' : 'error');

                    if (hasAmount) {
                        const amounts = data.map(r => r.amount).filter(a => a != null);
                        log(`   - Valeurs 'amount' non-null: ${amounts.length}`, 'info');
                        if (amounts.length > 0) {
                            log(`   - Premier amount: ${amounts[0]} (type: ${typeof amounts[0]})`, 'info');
                        }
                    }

                    if (hasMontant) {
                        const montants = data.map(r => r.montant).filter(m => m != null);
                        log(`   - Valeurs 'montant' non-null: ${montants.length}`, 'info');
                        if (montants.length > 0) {
                            log(`   - Premier montant: ${montants[0]} (type: ${typeof montants[0]})`, 'info');
                        }
                    }
                } else {
                    log('‚ö†Ô∏è Aucune recette trouv√©e', 'warning');
                    log('üí° V√©rifiez que des recettes existent pour cet utilisateur', 'warning');
                }

                return data;
            } catch (error) {
                log(`‚ùå Erreur inattendue: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function testMapping() {
            clear();
            log('üîç Test 3: Test du mapping des donn√©es...', 'info');

            if (!recettesData) {
                log('‚ö†Ô∏è Ex√©cutez d\'abord le Test 2', 'warning');
                await testRecettesRaw();
            }

            if (!recettesData || recettesData.length === 0) {
                log('‚ùå Aucune donn√©e √† mapper', 'error');
                return;
            }

            log('\nüîÑ Application du mapping (comme dans le code)...', 'info');

            const mappedRecettes = recettesData.map((recette, index) => {
                const mapped = {
                    id: recette.id,
                    userId: recette.user_id,
                    libelle: recette.description || recette.libelle || 'Sans titre',
                    montant: parseFloat(recette.amount || recette.montant || 0),
                    soldeDisponible: parseFloat(recette.solde_disponible || recette.soldeDisponible || 0),
                    description: recette.description || recette.libelle || '',
                    date: recette.receipt_date || recette.date || recette.created_at,
                    statut: recette.statut || 'Re√ßue',
                };

                if (index === 0) {
                    log('\nüìù Mapping de la premi√®re recette:', 'info');
                    log(`   Brut:`, 'info');
                    log(`      - amount: ${recette.amount}`, 'info');
                    log(`      - montant: ${recette.montant}`, 'info');
                    log(`      - description: ${recette.description}`, 'info');
                    log(`      - libelle: ${recette.libelle}`, 'info');
                    log(`   Mapp√©:`, 'success');
                    log(`      - montant: ${mapped.montant} (type: ${typeof mapped.montant})`, 'success');
                    log(`      - libelle: ${mapped.libelle}`, 'success');
                    log(`      - soldeDisponible: ${mapped.soldeDisponible}`, 'success');
                }

                return mapped;
            });

            log(`\n‚úÖ ${mappedRecettes.length} recettes mapp√©es`, 'success');

            // V√©rifier les montants
            const montantsNonZero = mappedRecettes.filter(r => r.montant > 0);
            log(`\nüí∞ Analyse des montants:`, 'info');
            log(`   - Recettes avec montant > 0: ${montantsNonZero.length}`, montantsNonZero.length > 0 ? 'success' : 'error');
            log(`   - Recettes avec montant = 0: ${mappedRecettes.length - montantsNonZero.length}`, 'warning');

            if (montantsNonZero.length === 0) {
                log('\n‚ùå PROBL√àME IDENTIFI√â: Tous les montants sont √† 0!', 'error');
                log('   Causes possibles:', 'warning');
                log('   1. La colonne "amount" n\'existe pas dans la base', 'warning');
                log('   2. La colonne "montant" n\'existe pas dans la base', 'warning');
                log('   3. Les valeurs sont NULL', 'warning');
                log('   4. Les valeurs ne sont pas num√©riques', 'warning');
            }

            return mappedRecettes;
        }

        async function testCalculTotal() {
            clear();
            log('üîç Test 4: Calcul du total (comme dans l\'app)...', 'info');

            if (!recettesData) {
                log('‚ö†Ô∏è Ex√©cutez d\'abord le Test 2', 'warning');
                await testRecettesRaw();
            }

            const mappedRecettes = recettesData.map(recette => ({
                montant: parseFloat(recette.amount || recette.montant || 0),
            }));

            log(`üìä Nombre de recettes: ${mappedRecettes.length}`, 'info');

            const totalRecettes = mappedRecettes.reduce((sum, r) => {
                const montant = r.montant || 0;
                log(`   + ${montant}`, 'info');
                return sum + montant;
            }, 0);

            log(`\nüí∞ TOTAL CALCUL√â: ${totalRecettes.toLocaleString('fr-FR')} F CFA`, totalRecettes > 0 ? 'success' : 'error');

            if (totalRecettes === 0) {
                log('\n‚ùå PROBL√àME CONFIRM√â: Le total est 0!', 'error');
                log('\nüîç V√©rification d√©taill√©e des 3 premi√®res recettes:', 'warning');
                
                recettesData.slice(0, 3).forEach((recette, index) => {
                    log(`\n   Recette ${index + 1}:`, 'info');
                    log(`      - recette.amount = ${recette.amount} (${typeof recette.amount})`, 'info');
                    log(`      - recette.montant = ${recette.montant} (${typeof recette.montant})`, 'info');
                    log(`      - parseFloat(recette.amount || recette.montant || 0) = ${parseFloat(recette.amount || recette.montant || 0)}`, 'info');
                });
            } else {
                log('‚úÖ Le calcul fonctionne correctement!', 'success');
            }

            return totalRecettes;
        }

        async function runAllTests() {
            clear();
            log('üöÄ Ex√©cution de tous les tests...\n', 'info');
            
            await testAuth();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testRecettesRaw();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testMapping();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testCalculTotal();
            
            log('\n‚úÖ Tous les tests termin√©s!', 'success');
        }

        // Auto-remplir avec les valeurs du localStorage si disponibles
        window.onload = () => {
            const savedUrl = localStorage.getItem('supabaseUrl');
            const savedKey = localStorage.getItem('supabaseKey');
            
            if (savedUrl) document.getElementById('supabaseUrl').value = savedUrl;
            if (savedKey) document.getElementById('supabaseKey').value = savedKey;
        };

        // Sauvegarder les valeurs
        document.getElementById('supabaseUrl')?.addEventListener('change', (e) => {
            localStorage.setItem('supabaseUrl', e.target.value);
        });
        document.getElementById('supabaseKey')?.addEventListener('change', (e) => {
            localStorage.setItem('supabaseKey', e.target.value);
        });
    </script>
</body>
</html>



